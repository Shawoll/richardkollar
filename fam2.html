<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bare Family ‚Ä¢ Pair your shoes</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<style>
  :root{
    --bg:#0e0f13; --panel:#151823e6; --text:#f3f4f6; --muted:#a1a1aa;
    --accent:#6ee7ff; --ok:#22c55e; --err:#ef4444; --border:#ffffff1a;
    --ring:#6ee7ff55;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background:radial-gradient(1100px 800px at 80% -10%, #1e2636 0%, #0e0f13 55%) fixed;
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  }

  .shell{min-height:100%; display:grid; grid-template-rows:auto 1fr auto; padding: max(16px, env(safe-area-inset-top)) 16px max(16px, env(safe-area-inset-bottom));}
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;
  }
  .brand{font-weight:800; letter-spacing:.3px}
  .badge{font-size:12px; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px}
  .progress{display:flex; align-items:center; gap:10px}
  .dot{
    width:28px; height:28px; border-radius:999px; display:grid; place-items:center; font-weight:700; font-size:14px;
    background:#0c1221; border:1px solid var(--border); color:var(--muted);
  }
  .dot.active{border-color:#6ee7ff66; color:#e6faff; box-shadow:0 0 0 3px var(--ring) inset}
  .bar{width:36px; height:3px; background:#2a3142; border-radius:999px}
  .bar.filled{background:#7bdfff}

  .screen{
    display:none; min-height:72vh; background:var(--panel); border:1px solid var(--border);
    border-radius:18px; padding:18px; backdrop-filter: blur(8px);
    box-shadow:0 10px 30px #0000006a;
  }
  .screen.active{display:grid; align-content:start; gap:16px}
  .title{font-size:28px; margin:6px 0 0}
  .subtitle{color:var(--muted); margin:0}

  .big-actions{display:grid; gap:12px; margin-top:6px}
  button{
    appearance:none; border:1px solid var(--border); background:#0f1322; color:var(--text);
    height:60px; padding:0 18px; border-radius:14px; font-weight:700; font-size:16px; cursor:pointer;
    transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease;
  }
  button:active{transform:translateY(1px)}
  button.primary{background:linear-gradient(180deg,#1f2a44,#172033); border-color:#6ee7ff55}
  button.primary:focus{outline:none; box-shadow:0 0 0 6px var(--ring)}
  button.ok{background:linear-gradient(180deg,#1e3a2f,#10261d); border-color:#22c55e66}
  button:disabled{opacity:.5; cursor:not-allowed}

  .field{display:flex; gap:8px}
  input[type=text]{
    flex:1; height:56px; border-radius:14px; padding:12px 14px; font-size:16px;
    color:var(--text); background:#0b1221; border:1px solid var(--border);
  }

  .video-wrap{
    margin-top:6px; position:relative; border:1px dashed #6ee7ff40; border-radius:16px; overflow:hidden; background:#0a0c14;
  }
  video{width:100%; display:block; aspect-ratio:16/10; background:#000}
  canvas.scan{position:absolute; inset:0; width:100%; height:100%; pointer-events:none; mix-blend-mode:screen; opacity:.9}

  .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; background:#0c1221; border:1px solid var(--border); border-radius:12px}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}

  footer{opacity:.65; font-size:12px; text-align:center; margin-top:10px}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom: max(18px, calc(env(safe-area-inset-bottom) + 12px));
    width:min(720px, calc(100% - 24px)); background:#0c1320; border:1px solid var(--border); padding:12px 14px; border-radius:12px; color:var(--muted); display:none}
  .toast.show{display:block} .toast.ok{border-left:4px solid var(--ok)} .toast.err{border-left:4px solid var(--err)} .toast.info{border-left:4px solid var(--accent)}

  #confetti{position:fixed; inset:0; pointer-events:none; display:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="shell" role="application" aria-describedby="ariaStatus">
  <header>
    <div>
      <div class="brand">Bare Family</div>
      <div class="badge" aria-hidden="true">Secure ‚Ä¢ Private ‚Ä¢ Local</div>
    </div>
    <nav class="progress" aria-label="Progress">
      <div class="dot" id="p1" aria-current="step">1</div>
      <div class="bar" id="b1"></div>
      <div class="dot" id="p2">2</div>
      <div class="bar" id="b2"></div>
      <div class="dot" id="p3">3</div>
    </nav>
  </header>

  <!-- STEP 1 -->
  <section id="step1" class="screen active" aria-labelledby="t1">
    <h1 id="t1" class="title">Step 1: Scan LEFT shoe</h1>
    <p class="subtitle">We‚Äôll guide you through one step at a time.</p>

    <div class="big-actions">
      <button class="primary" id="scanLeft">Scan left now</button>
      <div class="field">
        <input id="manual1" type="text" placeholder='Or paste: {"pairId":"ABC123","side":"L","model":"Urban Nomad","size":"42"} or BL-PAIR-ABC123-L' inputmode="text" aria-label="Manual QR content for LEFT">
        <button id="useManual1">Use</button>
      </div>
      <button id="demo1">Use demo LEFT</button>
    </div>

    <div class="video-wrap" id="vw1" hidden>
      <video id="video1" playsinline></video>
      <canvas id="overlay1" class="scan"></canvas>
    </div>

    <div class="row"><span>LEFT</span><b id="leftStatus" class="muted">not scanned</b></div>
    <div class="row"><span>Pair ID</span><b id="pid1" class="muted">‚Äî</b></div>

    <div class="big-actions">
      <button id="to2" class="ok" disabled>Continue to RIGHT ‚Üí</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section id="step2" class="screen" aria-labelledby="t2">
    <h1 id="t2" class="title">Step 2: Scan RIGHT shoe</h1>
    <p class="subtitle">Must match the same pair.</p>

    <div class="big-actions">
      <button class="primary" id="scanRight">Scan right now</button>
      <div class="field">
        <input id="manual2" type="text" placeholder='Or paste: {"pairId":"ABC123","side":"R"} or BL-PAIR-ABC123-R' aria-label="Manual QR content for RIGHT">
        <button id="useManual2">Use</button>
      </div>
      <button id="demo2">Use demo RIGHT</button>
    </div>

    <div class="video-wrap" id="vw2" hidden>
      <video id="video2" playsinline></video>
      <canvas id="overlay2" class="scan"></canvas>
    </div>

    <div class="row"><span>RIGHT</span><b id="rightStatus" class="muted">not scanned</b></div>
    <div class="row"><span>Pair ID</span><b id="pid2" class="muted">‚Äî</b></div>

    <div class="big-actions">
      <button id="back1">‚Üê Back</button>
      <button id="to3" class="ok" disabled>Finish & Join ‚Üí</button>
    </div>
  </section>

  <!-- STEP 3 -->
  <section id="step3" class="screen" aria-labelledby="t3">
    <h1 id="t3" class="title">Welcome to the family! ü•≥</h1>
    <p class="subtitle">Your pair is registered on this device.</p>

    <div class="row"><span>Pair</span><b id="sumPair" class="muted">‚Äî</b></div>
    <div class="row"><span>Model</span><b id="sumModel" class="muted">‚Äî</b></div>
    <div class="row"><span>Size</span><b id="sumSize" class="muted">‚Äî</b></div>
    <div class="row"><span>Registered</span><b id="sumDate" class="muted">‚Äî</b></div>

    <div class="big-actions">
      <button id="done" class="primary">Done</button>
      <button id="pairAnother">Pair another</button>
    </div>
  </section>

  <footer>You can port this wizard into React later. Data stays on this device.</footer>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="ariaStatus" class="sr-only" aria-live="polite"></div>
</div>

<!-- Fallback QR lib -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(() => {
  const $ = s => document.querySelector(s);

  // Elements
  const els = {
    // progress
    p1:$('#p1'), b1:$('#b1'), p2:$('#p2'), b2:$('#b2'), p3:$('#p3'),
    // step 1
    s1:$('#step1'), scanLeft:$('#scanLeft'), manual1:$('#manual1'), useManual1:$('#useManual1'), demo1:$('#demo1'),
    vwrap1:$('#vw1'), video1:$('#video1'), overlay1:$('#overlay1'),
    leftStatus:$('#leftStatus'), pid1:$('#pid1'), to2:$('#to2'),
    // step 2
    s2:$('#step2'), scanRight:$('#scanRight'), manual2:$('#manual2'), useManual2:$('#useManual2'), demo2:$('#demo2'),
    vwrap2:$('#vw2'), video2:$('#video2'), overlay2:$('#overlay2'),
    rightStatus:$('#rightStatus'), pid2:$('#pid2'), back1:$('#back1'), to3:$('#to3'),
    // step 3
    s3:$('#step3'), sumPair:$('#sumPair'), sumModel:$('#sumModel'), sumSize:$('#sumSize'), sumDate:$('#sumDate'),
    done:$('#done'), pairAnother:$('#pairAnother'),
    // misc
    toast:$('#toast'), confetti:$('#confetti'), aria:$('#ariaStatus'),
  };

  const state = {
    step: 1,
    left: null,
    right: null,
    pairMeta: null,
    // scanning
    stream: null, raf: null, detector: null, usingFallback:false, expectSide:null
  };

  // ---------- UI helpers ----------
  const vibrate = (p=[40]) => navigator.vibrate?.(p);
  const speak = (t) => els.aria.textContent = t;
  function toast(msg, kind='info'){
    const t = els.toast;
    t.textContent = msg; t.className = 'toast show ' + kind;
    clearTimeout(toast._t); toast._t = setTimeout(()=>{t.classList.remove('show')}, 3000);
  }

  function setStep(n){
    state.step = n;
    els.s1.classList.toggle('active', n===1);
    els.s2.classList.toggle('active', n===2);
    els.s3.classList.toggle('active', n===3);
    // progress visuals
    els.p1.classList.toggle('active', n===1);
    els.p2.classList.toggle('active', n===2);
    els.p3.classList.toggle('active', n===3);
    els.b1.classList.toggle('filled', n>=2);
    els.b2.classList.toggle('filled', n>=3);
    speak('Step ' + n);
  }

  function updateMeta(o){
    if(!o) return;
    if(!state.pairMeta){ state.pairMeta = { pairId:o.pairId, model:o.model, size:o.size }; }
    else{
      state.pairMeta.model ??= o.model;
      state.pairMeta.size ??= o.size;
    }
  }
  function updateStepUI(){
    els.leftStatus.textContent = state.left ? `LEFT ‚Ä¢ ${state.left.pairId}` : 'not scanned';
    els.leftStatus.className = state.left ? 'ok' : 'muted';
    els.pid1.textContent = state.left?.pairId ?? '‚Äî';
    els.to2.disabled = !state.left;

    els.rightStatus.textContent = state.right ? `RIGHT ‚Ä¢ ${state.right.pairId}` : 'not scanned';
    els.rightStatus.className = state.right ? 'ok' : 'muted';
    els.pid2.textContent = state.right?.pairId ?? '‚Äî';
    els.to3.disabled = !(state.left && state.right);
  }

  // ---------- QR parsing ----------
  function parseQR(raw){
    let obj=null;
    try{
      const j=JSON.parse(raw);
      if(j && j.pairId && j.side){
        obj = {
          pairId:String(j.pairId).trim(),
          side:String(j.side).toUpperCase()==='LEFT'?'L':String(j.side).toUpperCase()==='RIGHT'?'R':String(j.side).toUpperCase(),
          model: j.model? String(j.model):undefined,
          size:  j.size? String(j.size):undefined,
          raw
        };
      }
    }catch(_){}
    if(!obj){
      const [main, ...kv] = String(raw).trim().split(';');
      const m = main.match(/(?:^| )BL-PAIR-([A-Z0-9\-]+)-([LR])$/i);
      if(m){
        obj = { pairId:m[1].toUpperCase(), side:m[2].toUpperCase(), raw };
        for(const part of kv){
          const [k,v] = part.split('=');
          if(k && v){
            if(k.toLowerCase()==='model') obj.model=v;
            if(k.toLowerCase()==='size') obj.size=v;
          }
        }
      }
    }
    return obj;
  }
  function alreadyRegistered(pairId){
    const list = JSON.parse(localStorage.getItem('shoePairs')||'[]');
    return list.some(x=>x.pairId===pairId);
  }
  function saveRegistration(){
    const entry = {
      pairId: state.pairMeta?.pairId || state.left?.pairId || state.right?.pairId,
      model: state.pairMeta?.model || null,
      size: state.pairMeta?.size || null,
      leftRaw: state.left?.raw || null,
      rightRaw: state.right?.raw || null,
      registeredAt: new Date().toISOString()
    };
    const list = JSON.parse(localStorage.getItem('shoePairs')||'[]');
    list.push(entry);
    localStorage.setItem('shoePairs', JSON.stringify(list));
    return entry;
  }

  // ---------- Scanner ----------
  function loadDetector(){
    if('BarcodeDetector' in window){
      try{ state.detector = new window.BarcodeDetector({formats:['qr_code']}); return true; }catch(_){}
    }
    state.detector=null; return false;
  }
  async function startScan(side, videoEl, overlayEl, wrapperEl){
    stopScan();
    state.expectSide = side;
    wrapperEl.hidden = false;
    try{
      state.stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
      videoEl.srcObject = state.stream; await videoEl.play();
      const haveNative = loadDetector(); state.usingFallback = !haveNative;
      haveNative ? tickNative(videoEl, overlayEl) : tickFallback(videoEl, overlayEl);
      toast(`Scanner ready for ${side==='L'?'LEFT':'RIGHT'}`, 'info');
      speak(`Scanner opened for ${side==='L'?'left':'right'}`);
    }catch(err){
      console.error(err);
      toast('Camera not available. Paste code or use demo.', 'err');
      wrapperEl.hidden = true;
    }
  }
  function stopScan(){
    if(state.raf) cancelAnimationFrame(state.raf);
    state.raf=null;
    if(state.stream){ for(const t of state.stream.getTracks()) t.stop(); }
    state.stream=null; state.expectSide=null;
  }
  function handleResult(text){
    const parsed = parseQR(text);
    if(!parsed){ toast('Unrecognized QR content.', 'err'); vibrate([160]); return; }
    if(parsed.side !== state.expectSide){
      toast(`Scanned ${parsed.side==='L'?'LEFT':'RIGHT'}, but expected ${state.expectSide==='L'?'LEFT':'RIGHT'}.`, 'err');
      vibrate([200,60,200]); return;
    }
    if(alreadyRegistered(parsed.pairId)){ toast('This pair is already registered on this device.', 'err'); vibrate([200,40,200]); return; }

    // pair consistency
    if(state.left && parsed.side==='R' && parsed.pairId !== state.left.pairId){ toast('RIGHT belongs to a different pair.', 'err'); vibrate([180,40,180]); return; }
    if(state.right && parsed.side==='L' && parsed.pairId !== state.right.pairId){ toast('LEFT belongs to a different pair.', 'err'); vibrate([180,40,180]); return; }

    updateMeta(parsed);
    if(parsed.side==='L'){ state.left = parsed; els.leftStatus.textContent = `LEFT ‚Ä¢ ${parsed.pairId}`; els.leftStatus.className='ok'; els.pid1.textContent = parsed.pairId; }
    if(parsed.side==='R'){ state.right = parsed; els.rightStatus.textContent = `RIGHT ‚Ä¢ ${parsed.pairId}`; els.rightStatus.className='ok'; els.pid2.textContent = parsed.pairId; }
    updateStepUI();
    stopScan();
    vibrate([40,30,40]);
    if(state.step===1) els.to2.disabled=false;
    if(state.step===2 && state.left && state.right) els.to3.disabled=false;
  }

  function tickNative(videoEl, overlayEl){
    const ctx = overlayEl.getContext('2d');
    const loop = async () => {
      if(!state.detector) return;
      try{
        const codes = await state.detector.detect(videoEl);
        ctx.clearRect(0,0,overlayEl.width,overlayEl.height);
        if(codes?.length){
          const b = codes[0].boundingBox;
          drawRect(ctx, overlayEl, videoEl, b);
          handleResult(codes[0].rawValue);
          return;
        }
      }catch(e){
        console.warn('Detector error, switching to fallback', e);
        state.detector=null; state.usingFallback=true; tickFallback(videoEl, overlayEl); return;
      }
      state.raf = requestAnimationFrame(loop);
    };
    loop();
  }
  function tickFallback(videoEl, overlayEl){
    const ctx = overlayEl.getContext('2d');
    const loop = () => {
      if(!videoEl.videoWidth) { state.raf = requestAnimationFrame(loop); return; }
      // size canvas to element
      overlayEl.width = overlayEl.clientWidth * (window.devicePixelRatio||1);
      overlayEl.height = overlayEl.clientHeight * (window.devicePixelRatio||1);

      // offscreen copy
      const off = document.createElement('canvas');
      off.width = videoEl.videoWidth; off.height = videoEl.videoHeight;
      const octx = off.getContext('2d'); octx.drawImage(videoEl, 0,0,off.width,off.height);
      const img = octx.getImageData(0,0,off.width,off.height);
      if(window.jsQR){
        const code = jsQR(img.data, off.width, off.height, { inversionAttempts:"attemptBoth" });
        ctx.clearRect(0,0,overlayEl.width,overlayEl.height);
        if(code && code.data){ drawPoly(ctx, code.location); handleResult(code.data); return; }
      }
      state.raf = requestAnimationFrame(loop);
    };
    state.raf = requestAnimationFrame(loop);
  }
  function drawRect(ctx, canvas, videoEl, bbox){
    const rect = videoEl.getBoundingClientRect();
    const sx = canvas.width/rect.width, sy = canvas.height/rect.height;
    ctx.strokeStyle='rgba(110,231,255,.95)'; ctx.lineWidth=6;
    ctx.strokeRect(bbox.x*sx, bbox.y*sy, bbox.width*sx, bbox.height*sy);
  }
  function drawPoly(ctx, loc){
    ctx.lineWidth=6; ctx.strokeStyle='rgba(110,231,255,.95)';
    ctx.beginPath();
    ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
    ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
    ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
    ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
    ctx.closePath(); ctx.stroke();
  }

  // ---------- Celebrate ----------
  function fireConfetti(duration=2200, count=140){
    const c=els.confetti; c.style.display='block';
    const ctx=c.getContext('2d'); const DPR=window.devicePixelRatio||1;
    const resize=()=>{ c.width=innerWidth*DPR; c.height=innerHeight*DPR; }; resize();
    const parts = Array.from({length:count},()=>({
      x:Math.random()*c.width, y:-20, w:6+Math.random()*10, h:8+Math.random()*14,
      vx:-2+Math.random()*4, vy:4+Math.random()*6, rot:Math.random()*360, vr:-6+Math.random()*12,
      life:duration+Math.random()*600
    }));
    const start=performance.now();
    (function step(t){
      ctx.clearRect(0,0,c.width,c.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=.1; p.rot+=p.vr; p.life-=16;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
        ctx.fillStyle=['#6ee7ff','#22c55e','#a78bfa','#f59e0b','#f472b6'][p.rot|0 % 5];
        ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
      });
      if(t-start<duration) requestAnimationFrame(step); else c.style.display='none';
    })(start);
  }

  // ---------- Wire up ----------
  // Step 1
  els.scanLeft.addEventListener('click', ()=> startScan('L', els.video1, els.overlay1, els.vwrap1));
  els.useManual1.addEventListener('click', ()=> {
    if(!els.manual1.value.trim()) return toast('Paste code first.', 'info');
    state.expectSide='L'; handleResult(els.manual1.value.trim());
  });
  els.demo1.addEventListener('click', ()=>{
    const left='{"pairId":"NOMAD-8842","side":"L","model":"Urban Nomad","size":"42"}';
    state.expectSide='L'; handleResult(left);
  });
  els.to2.addEventListener('click', ()=> { setStep(2); });

  // Step 2
  els.scanRight.addEventListener('click', ()=> startScan('R', els.video2, els.overlay2, els.vwrap2));
  els.useManual2.addEventListener('click', ()=> {
    if(!els.manual2.value.trim()) return toast('Paste code first.', 'info');
    state.expectSide='R'; handleResult(els.manual2.value.trim());
  });
  els.demo2.addEventListener('click', ()=>{
    if(!state.left){ toast('Scan LEFT first.', 'info'); return; }
    const right=`{"pairId":"${state.left.pairId}","side":"R","model":"${state.pairMeta?.model||'Urban Nomad'}","size":"${state.pairMeta?.size||'42'}"}`;
    state.expectSide='R'; handleResult(right);
  });
  els.back1.addEventListener('click', ()=> { setStep(1); });

  // Finish
  els.to3.addEventListener('click', ()=>{
    const entry = saveRegistration();
    els.sumPair.textContent = entry.pairId || '‚Äî';
    els.sumModel.textContent = entry.model || '‚Äî';
    els.sumSize.textContent = entry.size || '‚Äî';
    els.sumDate.textContent = new Date(entry.registeredAt).toLocaleString();
    setStep(3);
    fireConfetti(); vibrate([30,50,150,50,30]); speak('Welcome to the family.');
  });
  els.done.addEventListener('click', ()=> { window.scrollTo({top:0,behavior:'smooth'}); });
  els.pairAnother.addEventListener('click', ()=> {
    stopScan();
    Object.assign(state, { step:1, left:null, right:null, pairMeta:null, stream:null, raf:null, detector:null, usingFallback:false, expectSide:null });
    updateStepUI(); els.vwrap1.hidden = true; els.vwrap2.hidden = true; setStep(1);
    toast('Ready for a new pair.', 'info');
  });

  // Clean up on unload
  window.addEventListener('pagehide', stopScan);

  // init
  setStep(1); updateStepUI();
})();
</script>
</body>
</html>